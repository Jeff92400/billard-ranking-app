<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Import Tournoi - Billard Ranking</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img src="images/billiard-icon.png" alt="üé±" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';"><span style="display:none;">üé±</span> Import d'un Tournoi</h2>
      <div class="nav-links">
        <a href="dashboard.html">Accueil</a>
        <a href="players-list.html">Joueurs</a>
        <a href="import-players.html">Import Joueurs</a>
        <a href="import-tournament.html">Import Tournoi</a>
        <a href="rankings.html">Classements</a>
        <a href="calendar.html">Calendrier</a>
        <a href="#" id="logoutBtn">D√©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <div class="card">
      <h3>Importer les r√©sultats d'un tournoi</h3>
      <p style="color: #666; margin-bottom: 20px;">
        S√©lectionnez la cat√©gorie, le num√©ro du tournoi (1, 2 ou 3) et la saison, puis importez le fichier CSV des r√©sultats.
      </p>

      <form id="importForm">
        <div class="form-group">
          <label for="categorySelect">Cat√©gorie *</label>
          <select id="categorySelect" required>
            <option value="">-- S√©lectionner une cat√©gorie --</option>
          </select>
        </div>

        <div class="form-group">
          <label for="tournamentNumber">Num√©ro du tournoi *</label>
          <select id="tournamentNumber" required>
            <option value="">-- S√©lectionner --</option>
            <option value="1">Tournoi 1</option>
            <option value="2">Tournoi 2</option>
            <option value="3">Tournoi 3</option>
            <option value="4">Finale D√©partementale</option>
          </select>
        </div>

        <div class="form-group">
          <label for="tournamentDate">Date du tournoi *</label>
          <input type="date" id="tournamentDate" required>
        </div>

        <div class="form-group">
          <label for="season">Saison (calcul√©e automatiquement)</label>
          <input type="text" id="season" placeholder="Ex: 2024-2025" readonly style="background: #f0f0f0;">
        </div>

        <div class="file-upload" id="fileUpload">
          <p>üìÅ Cliquez pour s√©lectionner un fichier CSV</p>
          <p style="font-size: 12px; color: #999; margin-top: 10px;">ou glissez-d√©posez le fichier ici</p>
          <input type="file" id="fileInput" accept=".csv" required>
          <div id="fileName" class="file-name" style="display: none;"></div>
        </div>

        <button type="submit" class="btn" id="importBtn">Importer le tournoi</button>
      </form>
    </div>

    <div class="card" id="resultsCard" style="display: none;">
      <h3>R√©sultats de l'import</h3>
      <div id="importResults"></div>
    </div>
  </div>

  <script>
    const API_URL = '/api';

    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    });

    // Calculate season from tournament date
    // September to July determines the season
    // Example: Oct 2025 ‚Üí 2025-2026, July 2026 ‚Üí 2025-2026, Sept 2026 ‚Üí 2026-2027
    function calculateSeason(dateString) {
      const date = new Date(dateString);
      const month = date.getMonth() + 1; // 1-12
      const year = date.getFullYear();

      // If month is September (9) or later, season starts this year
      // If month is before September, season started last year
      const startYear = month >= 9 ? year : year - 1;
      const endYear = startYear + 1;

      return `${startYear}-${endYear}`;
    }

    // Update season when tournament date changes
    document.getElementById('tournamentDate').addEventListener('change', (e) => {
      const date = e.target.value;
      if (date) {
        const season = calculateSeason(date);
        document.getElementById('season').value = season;
      }
    });

    // Load categories
    async function loadCategories() {
      try {
        const response = await fetch(`${API_URL}/tournaments/categories`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const categories = await response.json();
          const select = document.getElementById('categorySelect');

          categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.display_name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    }

    // File upload handling
    const fileUpload = document.getElementById('fileUpload');
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');

    fileUpload.addEventListener('click', () => {
      fileInput.click();
    });

    fileUpload.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileUpload.style.background = '#f0f0f0';
    });

    fileUpload.addEventListener('dragleave', () => {
      fileUpload.style.background = '';
    });

    fileUpload.addEventListener('drop', (e) => {
      e.preventDefault();
      fileUpload.style.background = '';

      if (e.dataTransfer.files.length > 0) {
        fileInput.files = e.dataTransfer.files;
        fileName.textContent = e.dataTransfer.files[0].name;
        fileName.style.display = 'block';
      }
    });

    fileInput.addEventListener('change', () => {
      if (fileInput.files.length > 0) {
        fileName.textContent = fileInput.files[0].name;
        fileName.style.display = 'block';
      }
    });

    // Form submission
    document.getElementById('importForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const errorDiv = document.getElementById('errorMessage');
      const successDiv = document.getElementById('successMessage');
      const importBtn = document.getElementById('importBtn');

      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';

      const categoryId = document.getElementById('categorySelect').value;
      const tournamentNumber = document.getElementById('tournamentNumber').value;
      const tournamentDate = document.getElementById('tournamentDate').value;
      const season = document.getElementById('season').value;

      if (!categoryId || !tournamentNumber || !tournamentDate || !season || !fileInput.files[0]) {
        errorDiv.textContent = 'Veuillez remplir tous les champs';
        errorDiv.style.display = 'block';
        return;
      }

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      formData.append('categoryId', categoryId);
      formData.append('tournamentNumber', tournamentNumber);
      formData.append('tournamentDate', tournamentDate);
      formData.append('season', season);

      importBtn.disabled = true;
      importBtn.textContent = 'Import en cours...';

      try {
        const response = await fetch(`${API_URL}/tournaments/import`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        const data = await response.json();

        if (response.ok) {
          successDiv.textContent = `Import r√©ussi ! ${data.imported} r√©sultats import√©s. Les classements ont √©t√© recalcul√©s.`;
          successDiv.style.display = 'block';

          // Show results
          const resultsCard = document.getElementById('resultsCard');
          const resultsDiv = document.getElementById('importResults');

          resultsDiv.innerHTML = `
            <div class="stats-grid">
              <div class="stat-card">
                <h4>R√©sultats import√©s</h4>
                <div class="stat-value">${data.imported}</div>
              </div>
            </div>
            <p style="margin-top: 20px;">
              <a href="rankings.html" class="btn btn-small">Voir les classements mis √† jour</a>
            </p>
          `;

          if (data.errors && data.errors.length > 0) {
            resultsDiv.innerHTML += `
              <div class="error" style="margin-top: 20px;">
                <strong>Erreurs rencontr√©es :</strong>
                <ul style="margin-top: 10px;">
                  ${data.errors.slice(0, 10).map(err => `<li>${err.licence || err.record}: ${err.error}</li>`).join('')}
                </ul>
              </div>
            `;
          }

          resultsCard.style.display = 'block';

          // Reset form
          fileInput.value = '';
          fileName.style.display = 'none';
          document.getElementById('importForm').reset();
        } else {
          errorDiv.textContent = data.error || 'Erreur lors de l\'import';
          errorDiv.style.display = 'block';
        }
      } catch (error) {
        errorDiv.textContent = 'Erreur de connexion au serveur';
        errorDiv.style.display = 'block';
      } finally {
        importBtn.disabled = false;
        importBtn.textContent = 'Importer le tournoi';
      }
    });

    // Initialize
    loadCategories();

    // Set today's date as default value
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('tournamentDate').value = today;

    // Auto-calculate season for today's date
    const season = calculateSeason(today);
    document.getElementById('season').value = season;
  </script>
</body>
</html>
